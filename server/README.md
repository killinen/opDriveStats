# Engagement Gauge Server

A minimal FastAPI application for serving the engagement statistics generated by `engagement_gauge_dev.py`.

## Features

- Serves aggregated engagement metrics per device (`GET /devices`).
- Provides detailed drive-level metrics for a device (`GET /devices/{device_id}`).
- Lightweight health check (`GET /health`).
- Simple HTML view that mirrors the CLI summary (`GET /stats`).
- Automatically reloads data whenever `engagement_db.json` changes.

## Prerequisites

- Python 3.10+ (Ubuntu 24.04 ships with Python 3.12).
- The `engagement_db.json` file generated by `engagement_gauge_dev.py`.

## Quick Start

```bash
# 1. Copy the project to the VPS (or clone from git after you push it)
scp -r engagement_gauge_dev oracle:~/engagement_gauge_dev

# 2. SSH into the VPS
ssh oracle
cd ~/engagement_gauge_dev

# 3. Create a Python virtual environment
python3 -m venv .venv
source .venv/bin/activate

# 4. Install the API dependencies
pip install --upgrade pip
pip install -r server/requirements.txt

# 5. Run the API (default port 8000)
uvicorn server.app:app --host 0.0.0.0 --port 8000
```

The API uses the `engagement_db.json` file located at the project root by default. To point at a different file, set the `ENGAGEMENT_DB_PATH` environment variable before launching uvicorn:

```bash
export ENGAGEMENT_DB_PATH=/home/oracle/data/engagement_db.json
uvicorn server.app:app --host 0.0.0.0 --port 8000
```

## Example Requests

```bash
curl http://<vps-ip>:8000/health
curl http://<vps-ip>:8000/devices
curl http://<vps-ip>:8000/devices/23a0dabf
# Browser view (HTML)
# http://<vps-ip>:8000/stats
```

The OpenAPI documentation is available at `http://<vps-ip>:8000/docs` once the service is running.

## Optional: systemd Service

Create a unit file (e.g. `/etc/systemd/system/engagement-gauge.service`):

```
[Unit]
Description=Engagement Gauge API
After=network.target

[Service]
User=oracle
Group=oracle
WorkingDirectory=/home/oracle/engagement_gauge_dev
Environment="ENGAGEMENT_DB_PATH=/home/oracle/engagement_gauge_dev/engagement_db.json"
ExecStart=/home/oracle/engagement_gauge_dev/.venv/bin/uvicorn server.app:app --host 0.0.0.0 --port 8000
Restart=always

[Install]
WantedBy=multi-user.target
```

Reload systemd and enable the service:

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now engagement-gauge.service
```

## Nginx Reverse Proxy with DuckDNS + HTTPS

1. **Create the DuckDNS record** – point `<subdomain>.duckdns.org` to your VPS public IP in the DuckDNS dashboard.
2. **Install Nginx and Certbot**:

   ```bash
   sudo apt update
   sudo apt install nginx
   sudo apt install certbot python3-certbot-nginx
   ```

3. **Open firewall/security ports** – allow inbound TCP 80/443 using UFW and the Oracle security list:

   ```bash
   sudo ufw allow 'Nginx Full'
   sudo ufw delete allow 'Nginx HTTP'  # optional cleanup if present
   ```

4. **Create an Nginx site** using the sample in `server/nginx.conf.example`, replacing the placeholder domain:

   ```bash
   sudo cp server/nginx.conf.example /etc/nginx/sites-available/engagement-gauge
   sudo ln -s /etc/nginx/sites-available/engagement-gauge /etc/nginx/sites-enabled/
   sudo nginx -t
   sudo systemctl reload nginx
   ```

5. **Obtain HTTPS certificates with Certbot**:

   ```bash
   sudo certbot --nginx -d <subdomain>.duckdns.org
   ```

   Certbot updates the Nginx config to terminate TLS on port 443 and configures automatic renewal (`/etc/cron.d/certbot`). Test renewal with `sudo certbot renew --dry-run`.

6. **Run uvicorn behind Nginx** – keep the FastAPI service bound to `127.0.0.1:8000` (systemd unit above already does this). Nginx proxies incoming HTTPS traffic to the local service.

After these steps your API is reachable at `https://<subdomain>.duckdns.org`, with Nginx handling TLS and forwarding requests while your FastAPI app stays on the internal loopback port.

## Security Notes

- Expose the API only on trusted networks or secure it behind a firewall/reverse proxy.
- Consider enabling HTTPS via a reverse proxy (e.g. Caddy, Nginx) if exposing publicly.
